\section{Descrizione della procedura di Ranging}
\begin{frame}{Two-way Ranging}
  Durante l'interazione fondamentale vengono scambiati, tra tag ed ancora,
  un messaggio di Poll, uno di Risposta ed uno di Final.\\
  I messaggi di \alert{Poll} e \alert{Final} vengono inviati dal tag a tutte
  le ancore. \\
  Il messaggio di \alert{Risposta} viene inviato dall'ancora
  al tag ed a tutte le altre ancore.
  \begin{center}
    \includegraphics[height=10em]{ranging.png}
  \end{center}
\end{frame}

\begin{frame}{Two-way Ranging}
  \begin{columns}[T]
    \begin{column}{0.5\textwidth}
      il \alert{tag} salva RMARKER di
      \begin{itemize}
      \item[-] invio Poll ($Rm_{ps}$)
      \item[-] ricezione Risposta ($Rm_{rr}$)
      \item[-] invio Final ($Rm_{fs}$) (delayed transmission)
      \end{itemize}
    \end{column}
    \begin{column}{0.5\textwidth}
      l'\alert{ancora} salva RMARKER di
      \begin{itemize}
      \item[-] ricezione Poll ($Rm_{pr}$)
      \item[-] spedizione Risposta ($Rm_{rs}$)
      \item[-] ricezione Final ($Rm_{fr}$)
      \end{itemize}
    \end{column}
  \end{columns}
  \begin{center}
    \includegraphics[scale = 0.7]{ranging_with_timings.png}
  \end{center}
  Il tag invia $Rm_{ps}$, $Rm_{rr}$ e $Rm_{fs}$ all'ancora nel Final
\end{frame}

\begin{frame}{Calcolo del ToF}
  Le seguenti quantità sono \alert{calcolate} dall'\alert{ancora} utilizzando i dati raccolti e
  ricevuti dal tag durante un'istanza di ranging
  \[
  \begin{split}
    T_{round1} = Rm_{rr} - Rm_{ps} \quad \quad T_{round2} = Rm_{fs} - Rm_{rr}\\
    T_{reply1} = Rm_{rs} - Rm_{pr} \quad \quad T_{reply2} = Rm_{fr} - Rm_{rs}
  \end{split}
  \]

  Alla ricezione del Final l'ancora calcola il nuovo Tof ($T_{prop}$) che viene inviato al tag nella Risposta al Poll dell'istanza di ranging \alert{successiva}
  \[
  T_{prop} = \frac{T_{round1} T_{round2} - T_{reply1} T_{reply2}}{T_{round1} + T_{round2} + T_{reply1} + T_{reply2}}
  \]
\end{frame}

\begin{frame}{Delayed transmission}
  \begin{alertblock}{Attenzione}
    La necessità di spedire nel messaggio di Final il tempo di spedizione del medesimo richiede
    l'utilizzo della funzione di \emph{delayed transmission} del DW1000.
  \end{alertblock}
  Il tempo di spedizione viene scelto a priori come
  \[
  Rm_{fs} = Rm_{ps} + \Delta
  \]
  dove $\Delta$ è maggiore del tempo impiegato da tutte le ancore per rispondere al tag (attenzione ad aumento di ancore).
  La funzione \emph{delayed transmission} garantisce che l'RMARKER di spedizione del Final coincida con
  $Rm_{fs}$
\end{frame}

\begin{frame}{Frame \& Superframe}
  Il sistema supporta \alert{nativamente} fino 8 tag e 3/4 ancore
  \centering
  \includegraphics[width=\linewidth]{frame_superframe_a2a.png}
\end{frame}

\begin{frame}{Gestione di più tag}
  Ogni tag invia un messaggio di Poll ogni \alert{activation time} $a_t$
  \[
  a_t = T_{sf} + T_{sr} + T_{sc}
  \]
  \begin{itemize}
  \item[-] $T_{sf}$: durata del Superframe 
  \item[-] $T_{sr}$: alla prima iterazione vale $\SI{10}{\milli\second}$ successivamente vale  $\SI{0}{\milli\second}$
  \item[-] $T_{sc}$: correzione calcolata dall'\alert{Ancora 0} ed inviata al \alert{tag i-esimo} 
  \end{itemize}
\end{frame}

\begin{frame}{Calcolo della correzione $T_{sc}$}
  La correzione viene calcolata in base ad un errore calcolato come la differenza tra il tempo atteso
  d'arrivo del Poll e quello effettivo (dal punto di vista dell'ancora 0)
  \[
  e = t_{i}^{a} - t_{rx}
  \]
  La correzione vale
  \[
  \begin{cases}
    T_{sc} = e \quad \quad \quad \quad \text{se } e < -\frac{T_{sf}}{2}\\
    T_{sc} = T_{sf} + e \quad \quad \text{altrimenti}
  \end{cases}
  \]
\end{frame}

\begin{frame}{Calcolo Calcolo del tempo di attivazione $T_{sc} = e$}
  Il tempo di riattivazione del tag $t_{i+1}^{t}$ è:
  \[
  t_{i+1}^{t} = t_{i}^{t} + T_{sf} + T_{sc} = t_i^a - (\cancel{e} + Tof) + T_{sf} + \cancel{e} = t_i^a - Tof + T_{sf} 
  \]
  \begin{center}
    \includegraphics[width=\linewidth]{sleep_correction_less_half_superframe.png}
  \end{center}
\end{frame}

\begin{frame}{Calcolo del tempo di attivazione $T_{sc} = e + T_{sf}$}
  Il tempo di riattivazione del tag $t_{i+1}^{t}$ è:
  \[
  t_{i+1}^{t} = t_{i}^{t} + T_{sf} + T_{sc} = t_i^a - (\cancel{e} + Tof) + T_{sf} + (\cancel{e} + T_{sf}) = t_i^a - Tof + 2T_{sf} 
  \]
  \begin{center}
    \includegraphics[width=\linewidth]{sleep_correction_greater_half_superframe.png}
  \end{center}
\end{frame}

\begin{frame}{Aumento della frequenza di ranging}
  \begin{center}
    \includegraphics[width=\linewidth]{pmg_frames_removal.png}
  \end{center}
      
  \begin{itemize}
  \item[-] contributo di Pinna, Malagoli, Giannini;
  \item[-] utilizzabile con un solo tag;
  \item[-] $T_{sf} = T_s = \SI{10}{\milli\second}$;
  \item[-] frequenza $ f = \SI{100}{\hertz}$.
  \end{itemize}
\end{frame}

\begin{frame}{Struttura generale di un messaggio}
  I messaggi inviati sia dal tag che dalle ancore hanno la seguente struttura
  \begin{center}
    \includegraphics[height=3.4em]{message_f.pdf}
  \end{center}
  \begin{itemize}
  \item[-] \lstinline!ctrl_frame!: maschera nella quale, tra le varie cose, viene decisa la modalità di
    indirizzamento
  \item[-] \lstinline!seq_num!: sequence number
  \item[-] \lstinline!pan_id!: ID della rete
  \item[-] \lstinline!dest_addr!: indirizzo del destinatario
  \item[-] \lstinline!src_addr!: indirizzo del mittente
  \item[-] \lstinline!msg_data!: payload (dipende dal tipo di messaggio)
  \item[-] \lstinline!crc!: cyclic redundandcy check
  \end{itemize}
\end{frame}

\begin{frame}{Messaggio di Poll - \lstinline!RTLS_DEMO_MSG_TAG_POLL!}
  \begin{center}
    \includegraphics[height=3.4em]{message_f_tag_poll.pdf}
  \end{center}
  \begin{itemize}
  \item[-] \lstinline!FCODE = RTLS_DEMO_MSG_TAG_POLL!
  \item[-] \lstinline!rangeNum!: range number della trasmissione
  \end{itemize}
\end{frame}

\begin{frame}{Messaggio di Final - \lstinline!RTLS_DEMO_MSG_TAG_FINAL!}
  \begin{center}
    \includegraphics[height=3.4em]{message_f_tag_final.pdf}
  \end{center}
  \begin{itemize}
  \item[-] \lstinline!FCODE = RTLS_DEMO_MSG_TAG_FINAL!
  \item[-] \lstinline!rangeNum!: range number della trasmissione
  \item[-] \lstinline!PTXT!: tempo di invio del Poll
  \item[-] \lstinline!RRXT0!: tempo di ricezione della risposta da ancora 0
  \item[-] \lstinline!RRXT1!: tempo di ricezione della risposta da ancora 1
  \item[-] \lstinline!RRXT2!: tempo di ricezione della risposta da ancora 2
  \item[-] \lstinline!RRXT3!: tempo di ricezione della risposta da ancora 3
  \item[-] \lstinline!FTXT!: tempo di invio del Final
  \item[-] \lstinline!VRESP!: maschera della risposte valide ricevute
  \end{itemize}
\end{frame}

\begin{frame}{Messaggio di Risposta - \lstinline!RTLS_DEMO_MSG_ANCH_RESP!}
  \begin{center}
    \includegraphics[height=3.4em]{message_f_anch_resp.pdf}
  \end{center}
  \begin{itemize}
  \item[-] \lstinline!FCODE = RTLS_DEMO_MSG_ANCH_RESP!
  \item[-] \lstinline!RES_TAG_SLP0!: parte alta dello sleep correction calcolato dall'ancora 0
  \item[-] \lstinline!RES_TAG_SLP1!: parte bassa dello sleep correction calcolato dall'ancora 0
  \item[-] \lstinline!PREVIOUS_TOF!: tof calcolato al passo precedente dall'ancora
  \item[-] \lstinline!rangeNum!: range number della trasmissione
  \end{itemize}
\end{frame}
